<!DOCTYPE html>
<html>
<head>
  <title>test.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../doc-style.css" />
  <script src="../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../";
    var thisFile = "public\\modules\\cloneable-readable\\test.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>test.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">'use strict'</span>

<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)
<span class="hljs-keyword">var</span> test = <span class="hljs-built_in">require</span>(<span class="hljs-string">'tape'</span>).test
<span class="hljs-keyword">var</span> <span class="hljs-keyword">from</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'from2'</span>)
<span class="hljs-keyword">var</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>)
<span class="hljs-keyword">var</span> sink = <span class="hljs-built_in">require</span>(<span class="hljs-string">'flush-write-stream'</span>)
<span class="hljs-keyword">var</span> pump = <span class="hljs-built_in">require</span>(<span class="hljs-string">'pump'</span>)
<span class="hljs-keyword">var</span> cloneable = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./'</span>)

test(<span class="hljs-string">'basic passthrough'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t</span>) </span>{
  t.plan(<span class="hljs-number">2</span>)

  <span class="hljs-keyword">var</span> read = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">var</span> source = <span class="hljs-keyword">from</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">size, next</span>) </span>{
    <span class="hljs-keyword">if</span> (read) {
      <span class="hljs-keyword">this</span>.push(<span class="hljs-literal">null</span>)
    } <span class="hljs-keyword">else</span> {
      read = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">this</span>.push(<span class="hljs-string">'hello world'</span>)
    }
    next()
  })

  <span class="hljs-keyword">var</span> instance = cloneable(source)
  t.notOk(read, <span class="hljs-string">'stream not started'</span>)

  instance.pipe(sink(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chunk, enc, cb</span>) </span>{
    t.equal(chunk.toString(), <span class="hljs-string">'hello world'</span>, <span class="hljs-string">'chunk matches'</span>)
    cb()
  }))
})

test(<span class="hljs-string">'clone sync'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t</span>) </span>{
  t.plan(<span class="hljs-number">4</span>)

  <span class="hljs-keyword">var</span> read = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">var</span> source = <span class="hljs-keyword">from</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">size, next</span>) </span>{
    <span class="hljs-keyword">if</span> (read) {
      <span class="hljs-keyword">this</span>.push(<span class="hljs-literal">null</span>)
    } <span class="hljs-keyword">else</span> {
      read = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">this</span>.push(<span class="hljs-string">'hello world'</span>)
    }
    next()
  })

  <span class="hljs-keyword">var</span> instance = cloneable(source)
  t.notOk(read, <span class="hljs-string">'stream not started'</span>)

  <span class="hljs-keyword">var</span> cloned = instance.clone()
  t.notOk(read, <span class="hljs-string">'stream not started'</span>)

  instance.pipe(sink(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chunk, enc, cb</span>) </span>{
    t.equal(chunk.toString(), <span class="hljs-string">'hello world'</span>, <span class="hljs-string">'chunk matches'</span>)
    cb()
  }))

  cloned.pipe(sink(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chunk, enc, cb</span>) </span>{
    t.equal(chunk.toString(), <span class="hljs-string">'hello world'</span>, <span class="hljs-string">'chunk matches'</span>)
    cb()
  }))
})

test(<span class="hljs-string">'clone async'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t</span>) </span>{
  t.plan(<span class="hljs-number">4</span>)

  <span class="hljs-keyword">var</span> read = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">var</span> source = <span class="hljs-keyword">from</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">size, next</span>) </span>{
    <span class="hljs-keyword">if</span> (read) {
      <span class="hljs-keyword">this</span>.push(<span class="hljs-literal">null</span>)
    } <span class="hljs-keyword">else</span> {
      read = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">this</span>.push(<span class="hljs-string">'hello world'</span>)
    }
    next()
  })

  <span class="hljs-keyword">var</span> instance = cloneable(source)
  t.notOk(read, <span class="hljs-string">'stream not started'</span>)

  <span class="hljs-keyword">var</span> cloned = instance.clone()
  t.notOk(read, <span class="hljs-string">'stream not started'</span>)

  instance.pipe(sink(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chunk, enc, cb</span>) </span>{
    t.equal(chunk.toString(), <span class="hljs-string">'hello world'</span>, <span class="hljs-string">'chunk matches'</span>)
    cb()
  }))

  setImmediate(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    cloned.pipe(sink(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chunk, enc, cb</span>) </span>{
      t.equal(chunk.toString(), <span class="hljs-string">'hello world'</span>, <span class="hljs-string">'chunk matches'</span>)
      cb()
    }))
  })
})

test(<span class="hljs-string">'basic passthrough in obj mode'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t</span>) </span>{
  t.plan(<span class="hljs-number">2</span>)

  <span class="hljs-keyword">var</span> read = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">var</span> source = <span class="hljs-keyword">from</span>.obj(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">size, next</span>) </span>{
    <span class="hljs-keyword">if</span> (read) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.push(<span class="hljs-literal">null</span>)
    } <span class="hljs-keyword">else</span> {
      read = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">this</span>.push({ <span class="hljs-attr">hello</span>: <span class="hljs-string">'world'</span> })
    }
    next()
  })

  <span class="hljs-keyword">var</span> instance = cloneable(source)
  t.notOk(read, <span class="hljs-string">'stream not started'</span>)

  instance.pipe(sink.obj(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chunk, enc, cb</span>) </span>{
    t.deepEqual(chunk, { <span class="hljs-attr">hello</span>: <span class="hljs-string">'world'</span> }, <span class="hljs-string">'chunk matches'</span>)
    cb()
  }))
})

test(<span class="hljs-string">'multiple clone in object mode'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t</span>) </span>{
  t.plan(<span class="hljs-number">4</span>)

  <span class="hljs-keyword">var</span> read = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">var</span> source = <span class="hljs-keyword">from</span>.obj(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">size, next</span>) </span>{
    <span class="hljs-keyword">if</span> (read) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.push(<span class="hljs-literal">null</span>)
    } <span class="hljs-keyword">else</span> {
      read = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">this</span>.push({ <span class="hljs-attr">hello</span>: <span class="hljs-string">'world'</span> })
    }
    next()
  })

  <span class="hljs-keyword">var</span> instance = cloneable(source)
  t.notOk(read, <span class="hljs-string">'stream not started'</span>)

  <span class="hljs-keyword">var</span> cloned = instance.clone()
  t.notOk(read, <span class="hljs-string">'stream not started'</span>)

  instance.pipe(sink.obj(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chunk, enc, cb</span>) </span>{
    t.deepEqual(chunk, { <span class="hljs-attr">hello</span>: <span class="hljs-string">'world'</span> }, <span class="hljs-string">'chunk matches'</span>)
    cb()
  }))

  setImmediate(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    cloned.pipe(sink.obj(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chunk, enc, cb</span>) </span>{
      t.deepEqual(chunk, { <span class="hljs-attr">hello</span>: <span class="hljs-string">'world'</span> }, <span class="hljs-string">'chunk matches'</span>)
      cb()
    }))
  })
})

test(<span class="hljs-string">'basic passthrough with data event'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t</span>) </span>{
  t.plan(<span class="hljs-number">2</span>)

  <span class="hljs-keyword">var</span> read = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">var</span> source = <span class="hljs-keyword">from</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">size, next</span>) </span>{
    <span class="hljs-keyword">if</span> (read) {
      <span class="hljs-keyword">this</span>.push(<span class="hljs-literal">null</span>)
    } <span class="hljs-keyword">else</span> {
      read = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">this</span>.push(<span class="hljs-string">'hello world'</span>)
    }
    next()
  })

  <span class="hljs-keyword">var</span> instance = cloneable(source)
  t.notOk(read, <span class="hljs-string">'stream not started'</span>)

  <span class="hljs-keyword">var</span> data = <span class="hljs-string">''</span>
  instance.on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chunk</span>) </span>{
    data += chunk.toString()
  })

  instance.on(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    t.equal(data, <span class="hljs-string">'hello world'</span>, <span class="hljs-string">'chunk matches'</span>)
  })
})

test(<span class="hljs-string">'basic passthrough with data event on clone'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t</span>) </span>{
  t.plan(<span class="hljs-number">3</span>)

  <span class="hljs-keyword">var</span> read = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">var</span> source = <span class="hljs-keyword">from</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">size, next</span>) </span>{
    <span class="hljs-keyword">if</span> (read) {
      <span class="hljs-keyword">this</span>.push(<span class="hljs-literal">null</span>)
    } <span class="hljs-keyword">else</span> {
      read = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">this</span>.push(<span class="hljs-string">'hello world'</span>)
    }
    next()
  })

  <span class="hljs-keyword">var</span> instance = cloneable(source)
  <span class="hljs-keyword">var</span> cloned = instance.clone()

  t.notOk(read, <span class="hljs-string">'stream not started'</span>)

  <span class="hljs-keyword">var</span> data = <span class="hljs-string">''</span>
  cloned.on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chunk</span>) </span>{
    data += chunk.toString()
  })

  cloned.on(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    t.equal(data, <span class="hljs-string">'hello world'</span>, <span class="hljs-string">'chunk matches in clone'</span>)
  })

  instance.pipe(sink(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chunk, enc, cb</span>) </span>{
    t.equal(chunk.toString(), <span class="hljs-string">'hello world'</span>, <span class="hljs-string">'chunk matches in instance'</span>)
    cb()
  }))
})

test(<span class="hljs-string">'errors if cloned after start'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t</span>) </span>{
  t.plan(<span class="hljs-number">2</span>)

  <span class="hljs-keyword">var</span> source = <span class="hljs-keyword">from</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">size, next</span>) </span>{
    <span class="hljs-keyword">this</span>.push(<span class="hljs-string">'hello world'</span>)
    <span class="hljs-keyword">this</span>.push(<span class="hljs-literal">null</span>)
    next()
  })

  <span class="hljs-keyword">var</span> instance = cloneable(source)

  instance.pipe(sink(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chunk, enc, cb</span>) </span>{
    t.equal(chunk.toString(), <span class="hljs-string">'hello world'</span>, <span class="hljs-string">'chunk matches'</span>)
    t.throws(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      instance.clone()
    }, <span class="hljs-string">'throws if cloned after start'</span>)
    cb()
  }))
})

test(<span class="hljs-string">'basic passthrough with readable event'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t</span>) </span>{
  t.plan(<span class="hljs-number">2</span>)

  <span class="hljs-keyword">var</span> read = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">var</span> source = <span class="hljs-keyword">from</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">size, next</span>) </span>{
    <span class="hljs-keyword">if</span> (read) {
      <span class="hljs-keyword">this</span>.push(<span class="hljs-literal">null</span>)
    } <span class="hljs-keyword">else</span> {
      read = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">this</span>.push(<span class="hljs-string">'hello world'</span>)
    }
    next()
  })

  <span class="hljs-keyword">var</span> instance = cloneable(source)
  t.notOk(read, <span class="hljs-string">'stream not started'</span>)

  <span class="hljs-keyword">var</span> data = <span class="hljs-string">''</span>
  instance.on(<span class="hljs-string">'readable'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> chunk
    <span class="hljs-keyword">while</span> ((chunk = <span class="hljs-keyword">this</span>.read()) !== <span class="hljs-literal">null</span>) {
      data += chunk.toString()
    }
  })

  instance.on(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    t.equal(data, <span class="hljs-string">'hello world'</span>, <span class="hljs-string">'chunk matches'</span>)
  })
})

test(<span class="hljs-string">'basic passthrough with readable event on clone'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t</span>) </span>{
  t.plan(<span class="hljs-number">3</span>)

  <span class="hljs-keyword">var</span> read = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">var</span> source = <span class="hljs-keyword">from</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">size, next</span>) </span>{
    <span class="hljs-keyword">if</span> (read) {
      <span class="hljs-keyword">this</span>.push(<span class="hljs-literal">null</span>)
    } <span class="hljs-keyword">else</span> {
      read = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">this</span>.push(<span class="hljs-string">'hello world'</span>)
    }
    next()
  })

  <span class="hljs-keyword">var</span> instance = cloneable(source)
  <span class="hljs-keyword">var</span> cloned = instance.clone()

  t.notOk(read, <span class="hljs-string">'stream not started'</span>)

  <span class="hljs-keyword">var</span> data = <span class="hljs-string">''</span>
  cloned.on(<span class="hljs-string">'readable'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> chunk
    <span class="hljs-keyword">while</span> ((chunk = <span class="hljs-keyword">this</span>.read()) !== <span class="hljs-literal">null</span>) {
      data += chunk.toString()
    }
  })

  cloned.on(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    t.equal(data, <span class="hljs-string">'hello world'</span>, <span class="hljs-string">'chunk matches in clone'</span>)
  })

  instance.pipe(sink(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chunk, enc, cb</span>) </span>{
    t.equal(chunk.toString(), <span class="hljs-string">'hello world'</span>, <span class="hljs-string">'chunk matches in instance'</span>)
    cb()
  }))
})

test(<span class="hljs-string">'source error destroys all'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t</span>) </span>{
  t.plan(<span class="hljs-number">3</span>)

  <span class="hljs-keyword">var</span> source = <span class="hljs-keyword">from</span>()
  <span class="hljs-keyword">var</span> instance = cloneable(source)
  <span class="hljs-keyword">var</span> clone = instance.clone()

  source.on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
    t.ok(err, <span class="hljs-string">'source errors'</span>)

    instance.on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err2</span>) </span>{
      t.ok(err === err2, <span class="hljs-string">'instance receives same error'</span>)
    })

    clone.on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err3</span>) </span>{
      t.ok(err === err3, <span class="hljs-string">'clone receives same error'</span>)
    })
  })

  source.emit(<span class="hljs-string">'error'</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>())
})

test(<span class="hljs-string">'source destroy destroys all'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t</span>) </span>{
  t.plan(<span class="hljs-number">2</span>)

  <span class="hljs-keyword">var</span> source = <span class="hljs-keyword">from</span>()
  <span class="hljs-keyword">var</span> instance = cloneable(source)
  <span class="hljs-keyword">var</span> clone = instance.clone()

  instance.on(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    t.pass(<span class="hljs-string">'instance has ended'</span>)
  })

  clone.on(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    t.pass(<span class="hljs-string">'clone has ended'</span>)
  })

  clone.resume()
  instance.resume()

  source.destroy()
})

test(<span class="hljs-string">'instance error destroys all but the source'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t</span>) </span>{
  t.plan(<span class="hljs-number">2</span>)

  <span class="hljs-keyword">var</span> source = <span class="hljs-keyword">from</span>()
  <span class="hljs-keyword">var</span> instance = cloneable(source)
  <span class="hljs-keyword">var</span> clone = instance.clone()

  source.on(<span class="hljs-string">'close'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    t.fail(<span class="hljs-string">'source should not be closed'</span>)
  })

  instance.on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
    t.is(err.message, <span class="hljs-string">'beep'</span>, <span class="hljs-string">'instance errors'</span>)
  })

  instance.on(<span class="hljs-string">'close'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    t.fail(<span class="hljs-string">'close should not be emitted'</span>)
  })

  clone.on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
    t.is(err.message, <span class="hljs-string">'beep'</span>, <span class="hljs-string">'instance errors'</span>)
  })

  clone.on(<span class="hljs-string">'close'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    t.fail(<span class="hljs-string">'close should not be emitted'</span>)
  })

  instance.destroy(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'beep'</span>))
})

test(<span class="hljs-string">'instance destroy destroys all but the source'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t</span>) </span>{
  t.plan(<span class="hljs-number">2</span>)

  <span class="hljs-keyword">var</span> source = <span class="hljs-keyword">from</span>()
  <span class="hljs-keyword">var</span> instance = cloneable(source)
  <span class="hljs-keyword">var</span> clone = instance.clone()

  source.on(<span class="hljs-string">'close'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    t.fail(<span class="hljs-string">'source should not be closed'</span>)
  })

  instance.on(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    t.pass(<span class="hljs-string">'instance has ended'</span>)
  })

  clone.on(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    t.pass(<span class="hljs-string">'clone has ended'</span>)
  })

  instance.resume()
  clone.resume()

  instance.destroy()
})

test(<span class="hljs-string">'clone destroy does not affect other clones, cloneable or source'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t</span>) </span>{
  t.plan(<span class="hljs-number">1</span>)

  <span class="hljs-keyword">var</span> source = <span class="hljs-keyword">from</span>()
  <span class="hljs-keyword">var</span> instance = cloneable(source)
  <span class="hljs-keyword">var</span> clone = instance.clone()
  <span class="hljs-keyword">var</span> other = instance.clone()

  source.on(<span class="hljs-string">'close'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    t.fail(<span class="hljs-string">'source should not be closed'</span>)
  })

  instance.on(<span class="hljs-string">'close'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    t.fail(<span class="hljs-string">'instance should not be closed'</span>)
  })

  other.on(<span class="hljs-string">'close'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    t.fail(<span class="hljs-string">'other clone should not be closed'</span>)
  })

  clone.on(<span class="hljs-string">'close'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    t.pass(<span class="hljs-string">'clone is closed'</span>)
  })

  clone.destroy()
})

test(<span class="hljs-string">'clone remains readable if other is destroyed'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t</span>) </span>{
  t.plan(<span class="hljs-number">3</span>)

  <span class="hljs-keyword">var</span> read = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">var</span> source = <span class="hljs-keyword">from</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">size, next</span>) </span>{
    <span class="hljs-keyword">if</span> (read) {
      <span class="hljs-keyword">this</span>.push(<span class="hljs-literal">null</span>)
    } <span class="hljs-keyword">else</span> {
      read = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">this</span>.push(<span class="hljs-string">'hello'</span>)
    }
    next()
  })

  <span class="hljs-keyword">var</span> instance = cloneable(source)
  <span class="hljs-keyword">var</span> clone = instance.clone()
  <span class="hljs-keyword">var</span> other = instance.clone()

  instance.pipe(sink.obj(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chunk, enc, cb</span>) </span>{
    t.deepEqual(chunk.toString(), <span class="hljs-string">'hello'</span>, <span class="hljs-string">'instance chunk matches'</span>)
    cb()
  }))

  clone.pipe(sink.obj(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chunk, enc, cb</span>) </span>{
    t.deepEqual(chunk.toString(), <span class="hljs-string">'hello'</span>, <span class="hljs-string">'clone chunk matches'</span>)
    cb()
  }))

  clone.on(<span class="hljs-string">'close'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    t.fail(<span class="hljs-string">'clone should not be closed'</span>)
  })

  instance.on(<span class="hljs-string">'close'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    t.fail(<span class="hljs-string">'instance should not be closed'</span>)
  })

  other.on(<span class="hljs-string">'close'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    t.pass(<span class="hljs-string">'other is closed'</span>)
  })

  other.destroy()
})

test(<span class="hljs-string">'clone of clone'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t</span>) </span>{
  t.plan(<span class="hljs-number">6</span>)

  <span class="hljs-keyword">var</span> read = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">var</span> source = <span class="hljs-keyword">from</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">size, next</span>) </span>{
    <span class="hljs-keyword">if</span> (read) {
      <span class="hljs-keyword">this</span>.push(<span class="hljs-literal">null</span>)
    } <span class="hljs-keyword">else</span> {
      read = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">this</span>.push(<span class="hljs-string">'hello world'</span>)
    }
    next()
  })

  <span class="hljs-keyword">var</span> instance = cloneable(source)
  t.notOk(read, <span class="hljs-string">'stream not started'</span>)

  <span class="hljs-keyword">var</span> cloned = instance.clone()
  t.notOk(read, <span class="hljs-string">'stream not started'</span>)

  <span class="hljs-keyword">var</span> replica = cloned.clone()
  t.notOk(read, <span class="hljs-string">'stream not started'</span>)

  instance.pipe(sink(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chunk, enc, cb</span>) </span>{
    t.equal(chunk.toString(), <span class="hljs-string">'hello world'</span>, <span class="hljs-string">'chunk matches'</span>)
    cb()
  }))

  cloned.pipe(sink(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chunk, enc, cb</span>) </span>{
    t.equal(chunk.toString(), <span class="hljs-string">'hello world'</span>, <span class="hljs-string">'chunk matches'</span>)
    cb()
  }))

  replica.pipe(sink(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chunk, enc, cb</span>) </span>{
    t.equal(chunk.toString(), <span class="hljs-string">'hello world'</span>, <span class="hljs-string">'chunk matches'</span>)
    cb()
  }))
})

test(<span class="hljs-string">'from vinyl'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t</span>) </span>{
  t.plan(<span class="hljs-number">3</span>)

  <span class="hljs-keyword">var</span> source = <span class="hljs-keyword">from</span>([<span class="hljs-string">'wa'</span>, <span class="hljs-string">'dup'</span>])

  <span class="hljs-keyword">var</span> instance = cloneable(source)
  <span class="hljs-keyword">var</span> clone = instance.clone()

  <span class="hljs-keyword">var</span> data = <span class="hljs-string">''</span>
  <span class="hljs-keyword">var</span> data2 = <span class="hljs-string">''</span>
  <span class="hljs-keyword">var</span> ends = <span class="hljs-number">2</span>

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">latch</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (--ends === <span class="hljs-number">0</span>) {
      t.equal(data, data2)
    }
  }

  instance.on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chunk</span>) </span>{
    data += chunk.toString()
  })

  process.nextTick(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    t.equal(<span class="hljs-string">''</span>, data, <span class="hljs-string">'nothing was written yet'</span>)
    t.equal(<span class="hljs-string">''</span>, data2, <span class="hljs-string">'nothing was written yet'</span>)

    clone.on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chunk</span>) </span>{
      data2 += chunk.toString()
    })
  })

  instance.on(<span class="hljs-string">'end'</span>, latch)
  clone.on(<span class="hljs-string">'end'</span>, latch)
})

test(<span class="hljs-string">'waits till all are flowing'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t</span>) </span>{
  t.plan(<span class="hljs-number">1</span>)

  <span class="hljs-keyword">var</span> source = <span class="hljs-keyword">from</span>([<span class="hljs-string">'wa'</span>, <span class="hljs-string">'dup'</span>])

  <span class="hljs-keyword">var</span> instance = cloneable(source)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>we create a clone</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  instance.clone()

  instance.on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chunk</span>) </span>{
    t.fail(<span class="hljs-string">'this should never happen'</span>)
  })

  process.nextTick(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    t.pass(<span class="hljs-string">'wait till nextTick'</span>)
  })
})

test(<span class="hljs-string">'isCloneable'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t</span>) </span>{
  t.plan(<span class="hljs-number">4</span>)

  <span class="hljs-keyword">var</span> source = <span class="hljs-keyword">from</span>([<span class="hljs-string">'hello'</span>, <span class="hljs-string">' '</span>, <span class="hljs-string">'world'</span>])
  t.notOk(cloneable.isCloneable(source), <span class="hljs-string">'a generic readable is not cloneable'</span>)

  <span class="hljs-keyword">var</span> instance = cloneable(source)
  t.ok(cloneable.isCloneable(instance), <span class="hljs-string">'a cloneable is cloneable'</span>)

  <span class="hljs-keyword">var</span> clone = instance.clone()
  t.ok(cloneable.isCloneable(clone), <span class="hljs-string">'a clone is cloneable'</span>)

  <span class="hljs-keyword">var</span> cloneClone = clone.clone()
  t.ok(cloneable.isCloneable(cloneClone), <span class="hljs-string">'a clone of a clone is cloneable'</span>)
})

test(<span class="hljs-string">'emits finish'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t</span>) </span>{
  <span class="hljs-keyword">var</span> chunks = [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-literal">null</span>]
  <span class="hljs-keyword">var</span> e1 = [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>]
  <span class="hljs-keyword">var</span> e2 = [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>]

  t.plan(<span class="hljs-number">2</span> + e1.length + e2.length)

  <span class="hljs-keyword">var</span> source = <span class="hljs-keyword">from</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">size, next</span>) </span>{
    setImmediate(next, <span class="hljs-literal">null</span>, chunks.shift())
  })

  <span class="hljs-keyword">var</span> instance = cloneable(source)

  <span class="hljs-keyword">var</span> clone = instance.clone()

  clone.on(<span class="hljs-string">'finish'</span>, t.pass.bind(<span class="hljs-literal">null</span>, <span class="hljs-string">'clone emits finish'</span>))
  instance.on(<span class="hljs-string">'finish'</span>, t.pass.bind(<span class="hljs-literal">null</span>, <span class="hljs-string">'main emits finish'</span>))

  instance.pipe(sink(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chunk, enc, cb</span>) </span>{
    t.equal(chunk.toString(), e1.shift(), <span class="hljs-string">'chunk matches'</span>)
    cb()
  }))

  clone.on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chunk</span>) </span>{
    t.equal(chunk.toString(), e2.shift(), <span class="hljs-string">'chunk matches'</span>)
  })
})

test(<span class="hljs-string">'clone async w resume'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t</span>) </span>{
  t.plan(<span class="hljs-number">4</span>)

  <span class="hljs-keyword">var</span> read = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">var</span> source = <span class="hljs-keyword">from</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">size, next</span>) </span>{
    <span class="hljs-keyword">if</span> (read) {
      <span class="hljs-keyword">this</span>.push(<span class="hljs-literal">null</span>)
    } <span class="hljs-keyword">else</span> {
      read = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">this</span>.push(<span class="hljs-string">'hello world'</span>)
    }
    next()
  })

  <span class="hljs-keyword">var</span> instance = cloneable(source)
  t.notOk(read, <span class="hljs-string">'stream not started'</span>)

  <span class="hljs-keyword">var</span> cloned = instance.clone()
  t.notOk(read, <span class="hljs-string">'stream not started'</span>)

  instance.on(<span class="hljs-string">'end'</span>, t.pass.bind(<span class="hljs-literal">null</span>, <span class="hljs-string">'end emitted'</span>))
  instance.resume()

  setImmediate(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    cloned.on(<span class="hljs-string">'end'</span>, t.pass.bind(<span class="hljs-literal">null</span>, <span class="hljs-string">'end emitted'</span>))
    cloned.resume()
  })
})

test(<span class="hljs-string">'big file'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t</span>) </span>{
  t.plan(<span class="hljs-number">13</span>)

  <span class="hljs-keyword">var</span> stream = cloneable(fs.createReadStream(path.join(__dirname, <span class="hljs-string">'big'</span>)))
  <span class="hljs-keyword">var</span> hash = crypto.createHash(<span class="hljs-string">'sha1'</span>)
  hash.setEncoding(<span class="hljs-string">'hex'</span>)

  <span class="hljs-keyword">var</span> toCheck

  fs.createReadStream(path.join(__dirname, <span class="hljs-string">'big'</span>))
    .pipe(hash)
    .once(<span class="hljs-string">'readable'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      toCheck = hash.read()
      t.ok(toCheck)
    })

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pipe</span> (<span class="hljs-params">s, num</span>) </span>{
    s.on(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      t.pass(<span class="hljs-string">'end for '</span> + num)
    })

    <span class="hljs-keyword">var</span> dest = path.join(__dirname, <span class="hljs-string">'out'</span>)

    s.pipe(fs.createWriteStream(dest))
      .on(<span class="hljs-string">'finish'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        t.pass(<span class="hljs-string">'finish for '</span> + num)

        <span class="hljs-keyword">var</span> destHash = crypto.createHash(<span class="hljs-string">'sha1'</span>)
        destHash.setEncoding(<span class="hljs-string">'hex'</span>)

        fs.createReadStream(dest)
          .pipe(destHash)
          .once(<span class="hljs-string">'readable'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> hash = destHash.read()
            t.ok(hash)
            t.equal(hash, toCheck)
          })
      })
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>Pipe in another event loop tick &lt;-- this one finished only, it's the original cloneable.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  setImmediate(pipe.bind(<span class="hljs-literal">null</span>, stream, <span class="hljs-number">1</span>))

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>Pipe in the same event loop tick</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  pipe(stream.clone(), <span class="hljs-number">0</span>)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>Pipe a long time after</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  setTimeout(pipe.bind(<span class="hljs-literal">null</span>, stream.clone(), <span class="hljs-number">2</span>), <span class="hljs-number">1000</span>)
})

test(<span class="hljs-string">'pump error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t</span>) </span>{
  t.plan(<span class="hljs-number">1</span>)

  <span class="hljs-keyword">var</span> err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'kaboom'</span>)

  pump([
    cloneable(<span class="hljs-keyword">from</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">this</span>.destroy(err)
    })),
    sink(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chunk, enc, cb</span>) </span>{
      t.fail(<span class="hljs-string">'this should not be called'</span>)
    })
  ], <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">_err</span>) </span>{
    t.equal(_err, err)
  })
})

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
